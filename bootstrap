#!/usr/bin/env bash

set -e

echo "üöÄ NixOS Configuration Bootstrap"
echo "================================"
echo ""

DETECTED_HOSTNAME=$(hostname)
DETECTED_USERNAME=$USER
DETECTED_TIMEZONE=$(cat /etc/timezone 2>/dev/null || echo "America/Edmonton")
DETECTED_LOCALE=${LANG:-en_GB.UTF-8}

read -p "Hostname [$DETECTED_HOSTNAME]: " INPUT_HOSTNAME
HOSTNAME=${INPUT_HOSTNAME:-$DETECTED_HOSTNAME}

read -p "Username [$DETECTED_USERNAME]: " INPUT_USERNAME
USERNAME=${INPUT_USERNAME:-$DETECTED_USERNAME}

read -p "Full name: " FULLNAME
while [ -z "$FULLNAME" ]; do
    echo "Full name is required"
    read -p "Full name: " FULLNAME
done

read -p "Timezone [$DETECTED_TIMEZONE]: " INPUT_TIMEZONE
TIMEZONE=${INPUT_TIMEZONE:-$DETECTED_TIMEZONE}

read -p "Locale [$DETECTED_LOCALE]: " INPUT_LOCALE
LOCALE=${INPUT_LOCALE:-$DETECTED_LOCALE}

REPO_URL="https://github.com/piredman/nixos-config.git"
TARGET_DIR="/home/$USERNAME/.dotfiles"

echo ""
echo "üìã Configuration Summary:"
echo "  Hostname: $HOSTNAME"
echo "  Username: $USERNAME"
echo "  Full name: $FULLNAME"
echo "  Timezone: $TIMEZONE"
echo "  Locale: $LOCALE"
echo "  Target: $TARGET_DIR"
echo ""

read -p "Proceed? (y/N): " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

echo ""
echo "üì¶ Cloning repository..."
if [ -d "$TARGET_DIR" ]; then
    echo "‚ö†Ô∏è  Directory $TARGET_DIR already exists!"
    read -p "Remove and re-clone? (y/N): " RECLONE
    if [[ "$RECLONE" =~ ^[Yy]$ ]]; then
        rm -rf "$TARGET_DIR"
    else
        echo "Aborted."
        exit 1
    fi
fi

git clone "$REPO_URL" "$TARGET_DIR"
cd "$TARGET_DIR"

echo ""
echo "‚úÖ Repository cloned to $TARGET_DIR"
echo ""
echo "üìö NEXT STEPS - Manual Configuration Required"
echo "=============================================="
echo ""
echo "Your NixOS configuration repository is ready."
echo "You now need to set up your host configuration."
echo ""
echo "See the complete guide: $TARGET_DIR/docs/BOOTSTRAP.md"
echo ""
echo "Quick overview:"
echo "  1. cd $TARGET_DIR"
echo "  2. Copy an existing host:"
echo "     cp -r hosts/terra hosts/$HOSTNAME"
echo "  3. Customize settings:"
echo "     vim hosts/$HOSTNAME/settings.nix"
echo "  4. Copy hardware config:"
echo "     sudo cp /etc/nixos/hardware-configuration.nix hosts/$HOSTNAME/"
echo "  5. Configure module groups:"
echo "     vim hosts/$HOSTNAME/home.nix"
echo "  6. Apply configuration:"
echo "     sudo nixos-rebuild switch --flake .#$HOSTNAME"
echo ""
echo "For detailed step-by-step instructions, see docs/BOOTSTRAP.md"

echo ""
